<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>Airbnb Barcelona Price Prediction - Emma's Blog</title>

  <!-- Edit site and author settings in `_config.yml` to make the social details your own -->

    <meta content="Emma's Blog" property="og:site_name">
  
    <meta content="Airbnb Barcelona Price Prediction" property="og:title">
  
  
    <meta content="article" property="og:type">
  
  
    <meta content="explore data cleaning and transformation" property="og:description">
  
  
    <meta content="/airbnb-barcelona/" property="og:url">
  
  
    <meta content="2020-03-15T02:00:00+00:00" property="article:published_time">
    <meta content="/about/" property="article:author">
  
  
    <meta content="/assets/img/barcelona.jpeg" property="og:image">
  
  
    
  
  
    
    <meta content="machine-learning" property="article:tag">
    
  

    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="@">
    <meta name="twitter:creator" content="@3mmasun# add your Twitter handle">
  
    <meta name="twitter:title" content="Airbnb Barcelona Price Prediction">
  
  
    <meta name="twitter:url" content="/airbnb-barcelona/">
  
  
    <meta name="twitter:description" content="explore data cleaning and transformation">
  
  
    <meta name="twitter:image:src" content="/assets/img/barcelona.jpeg">
  

	<meta name="description" content="explore data cleaning and transformation">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<meta property="og:image" content="">
	<link rel="shortcut icon" href="/assets/img/favicon/favicon.ico" type="image/x-icon">
	<link rel="apple-touch-icon" href="/assets/img/favicon/apple-touch-icon.png">
	<link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicon/favicon-32x32.png">
	<link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicon/apple-touch-icon.png">
	<!-- Chrome, Firefox OS and Opera -->
	<meta name="theme-color" content="#263959">
	<!-- Windows Phone -->
	<meta name="msapplication-navbutton-color" content="#263959">
	<!-- iOS Safari -->
	<meta name="apple-mobile-web-app-status-bar-style" content="#263959">
	<!-- Google Fonts -->
	<link href="https://fonts.googleapis.com/css?family=PT+Serif:400,700" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css?family=Lato:300,400,700" rel="stylesheet">
	<!-- Font Awesome -->
	<link rel="stylesheet" href="/assets/fonts/font-awesome/css/font-awesome.min.css">
	<!-- Styles -->
	<link rel="stylesheet" href="/assets/css/main.css">
</head>

<body>

  <div class="wrapper">
    <aside class="sidebar">
  <header>
    <div class="about">
      <div class="cover-author-image">
        <a href="/"><img src="/assets/img/emma.jpg" alt="Emma Sun"></a>
      </div>
      <div class="author-name">Emma Sun</div>
      <p>I am an Application Developer, exploring Data Engineering recently.</p>
    </div>
  </header>
  <!-- End Header -->
  <footer>
    <section class="contact">
      <h3 class="contact-title">Contact me</h3>
      <ul>
        <li>
          <a href="https://twitter.com/3mmasun# add your Twitter handle" target="_blank">
            <i aria-hidden="true" class="fa fa-twitter"></i>
          </a>
        </li>
        <!-- <li>
          <a href="https://facebook.com/" target="_blank">
            <i aria-hidden="true" class="fa fa-facebook"></i>
          </a>
        </li> -->
        <li class="github">
          <a href="http://github.com/3mmasun" target="_blank">
            <i class="fa fa-github"></i>
          </a>
        </li>
        <!-- <li class="linkedin">
          <a href="https://in.linkedin.com/in/" target="_blank">
            <i class="fa fa-linkedin"></i>
          </a>
        </li> -->
        <li class="email">
          <a href="mailto:emmasun.c@gmail.com">
            <i class="fa fa-envelope-o"></i>
          </a>
        </li>
      </ul>
    </section>
    <!-- End Section Contact -->
    <div class="copyright">
      <p>2020
        &copy;
        Emma Sun</p>
    </div>
  </footer>
  <!-- End Footer -->
</aside>
<!-- End Sidebar -->
<div class="content-box clearfix">
  <article class="article-page">
  <div class="page-content">
    
    <div class="page-cover-image">
      <figure>
        <img class="page-image" src=/assets/img/barcelona.jpeg alt="Airbnb Barcelona Price Prediction">
        
      </figure>
    </div> <!-- End Page Cover Image -->
    
    <div class="wrap-content">
      <header class="header-page">
        <h1 class="page-title">Airbnb Barcelona Price Prediction</h1>
        <div class="page-date"><span>2020, Mar 15&nbsp;&nbsp;&nbsp;&nbsp;</span></div>
      </header>
      <p>This post documents the steps involved training a simple model to predict the price in Airbnb Barcelona listing, covering following section:</p>
<ul>
  <li>Data Exploring</li>
  <li>Transformation</li>
  <li>Training the model</li>
  <li>Encode model and upload</li>
</ul>

<p>The repository is <a href="https://github.com/3mmasun/airbnb-ml">here</a> if you would like to check the code.</p>

<p><a href="https://images.unsplash.com/photo-1539037116277-4db20889f2d4?ixlib=rb-1.2.1&amp;ixid=eyJhcHBfaWQiOjEyMDd9&amp;auto=format&amp;fit=crop&amp;w=2250&amp;q=80">image source</a></p>

<h1 id="data-exploring">Data Exploring</h1>
<p>Airbnb data can be obtained from <a href="http://insideairbnb.com/get-the-data.html">http://insideairbnb.com/get-the-data.html</a></p>

<p>Here we used the data from Dec 2019 for Barcelona, Spain. You can obtain a copy <a href="https://github.com/3mmasun/airbnb-ml/tree/master/barcelona-12-2019">here</a></p>

<p>The original data in listings.csv.gz has over 100 columns, the final data frame used for price prediction only had 43 columns including ‘Price’ target. Many of them were dropped because they were mostly no value, or same value, or has high correlation with other columns.</p>

<h2 id="object-columns">Object Columns</h2>

<table>
  <thead>
    <tr>
      <th>Column</th>
      <th>Transformation</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>host_id</td>
      <td>none</td>
    </tr>
    <tr>
      <td>host_response_time</td>
      <td>drop_rows_occurs_less_than(1) -&gt;fillna_with_lowest_occurance -&gt;dic_host_response_time</td>
    </tr>
    <tr>
      <td>host_is_superhost</td>
      <td>encode_boolean_to_float -&gt;fillna False</td>
    </tr>
    <tr>
      <td>host_verifications</td>
      <td>extract_num_of_items_for_column</td>
    </tr>
    <tr>
      <td>host_has_profile_pic</td>
      <td>encode_boolean_to_float -&gt;fillna False</td>
    </tr>
    <tr>
      <td>host_identity_verified</td>
      <td>encode_boolean_to_float -&gt;fillna False</td>
    </tr>
    <tr>
      <td>neighbourhood_group_cleansed</td>
      <td>drop_rows_occurs_less_than(1) -&gt;encode_category_dic</td>
    </tr>
    <tr>
      <td>is_location_exact</td>
      <td>encode_boolean_to_float</td>
    </tr>
    <tr>
      <td>property_type</td>
      <td>encode_category_dic</td>
    </tr>
    <tr>
      <td>room_type</td>
      <td>encode_category_dic</td>
    </tr>
    <tr>
      <td>bed_type</td>
      <td>encode_category_dic</td>
    </tr>
    <tr>
      <td>amenities</td>
      <td>extract_num_of_items_for_column</td>
    </tr>
    <tr>
      <td>has_availability</td>
      <td>encode_boolean_to_float</td>
    </tr>
    <tr>
      <td>instant_bookable</td>
      <td>encode_boolean_to_float</td>
    </tr>
    <tr>
      <td>cancellation_policy</td>
      <td>drop_rows_occurs_less_than(2) -&gt; encode_category_dic</td>
    </tr>
    <tr>
      <td>require_guest_profile_picture</td>
      <td>encode_boolean_to_float</td>
    </tr>
    <tr>
      <td>require_guest_phone_verification</td>
      <td>encode_boolean_to_float</td>
    </tr>
  </tbody>
</table>

<h2 id="numeric-columns">Numeric Columns</h2>

<p>All na were filled with mean</p>

<table>
  <thead>
    <tr>
      <th>Column</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>host_response_rate</td>
    </tr>
    <tr>
      <td>latitude</td>
    </tr>
    <tr>
      <td>longitude</td>
    </tr>
    <tr>
      <td>accommodates</td>
    </tr>
    <tr>
      <td>bathrooms</td>
    </tr>
    <tr>
      <td>bedrooms</td>
    </tr>
    <tr>
      <td>beds</td>
    </tr>
    <tr>
      <td>price</td>
    </tr>
    <tr>
      <td>security_deposit</td>
    </tr>
    <tr>
      <td>cleaning_fee</td>
    </tr>
    <tr>
      <td>guests_included</td>
    </tr>
    <tr>
      <td>extra_people</td>
    </tr>
    <tr>
      <td>availability_365</td>
    </tr>
    <tr>
      <td>number_of_reviews</td>
    </tr>
    <tr>
      <td>review_scores_rating</td>
    </tr>
    <tr>
      <td>review_scores_accuracy</td>
    </tr>
    <tr>
      <td>review_scores_cleanliness</td>
    </tr>
    <tr>
      <td>review_scores_checkin</td>
    </tr>
    <tr>
      <td>review_scores_communication</td>
    </tr>
    <tr>
      <td>review_scores_location</td>
    </tr>
    <tr>
      <td>review_scores_value</td>
    </tr>
    <tr>
      <td>calculated_host_listings_count</td>
    </tr>
    <tr>
      <td>calculated_host_listings_count_entire_homes</td>
    </tr>
    <tr>
      <td>calculated_host_listings_count_private_rooms</td>
    </tr>
    <tr>
      <td>calculated_host_listings_count_shared_rooms</td>
    </tr>
    <tr>
      <td>review_per_month</td>
    </tr>
  </tbody>
</table>

<h2 id="folder-structure">Folder structure</h2>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>airbnb-ml
  |-- notebooks <span class="c"># experimental</span>
  |-- models <span class="c"># exported models</span>
  |-- src
    |-- transform.py
    |-- const.py
    |-- pipeline.py
    |-- app.py <span class="c"># flask app for price prediction</span>
    |-- __init__.py <span class="c"># makes everything in src folder an package</span>
    |-- tests
      |-- test_transform.py
  |-- Dockerfile <span class="c"># to dockerize prediction app</span>
  |-- requirements.txt
  |-- requirements-dev.txt
</code></pre></div></div>

<h2 id="testing-framework">Testing Framework</h2>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># requirements-dev.txt</span>
<span class="nv">nose</span><span class="o">==</span>1.3.7
nose-watch<span class="o">==</span>0.9.2
<span class="nv">rednose</span><span class="o">==</span>1.3.0
</code></pre></div></div>

<h1 id="transformation">Transformation</h1>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">drop_rows_occurs_less_than</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">column_name</span><span class="p">,</span> <span class="n">low_bound</span><span class="p">):</span>
    <span class="n">counts</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">column_name</span><span class="p">].</span><span class="n">value_counts</span><span class="p">()</span>
    <span class="n">to_remove</span> <span class="o">=</span> <span class="n">counts</span><span class="p">[</span><span class="n">counts</span> <span class="o">&lt;=</span> <span class="n">low_bound</span><span class="p">].</span><span class="n">index</span>
    <span class="n">new_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="o">~</span><span class="n">df</span><span class="p">[</span><span class="n">column_name</span><span class="p">].</span><span class="n">isin</span><span class="p">(</span><span class="n">to_remove</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">new_df</span>

<span class="k">def</span> <span class="nf">fillna_with_lowest_occurance</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">column_name</span><span class="p">):</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="n">fillna</span><span class="p">(</span>
        <span class="n">value</span><span class="o">=</span><span class="p">{</span><span class="n">column_name</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="n">column_name</span><span class="p">].</span><span class="n">value_counts</span><span class="p">().</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]})</span>
    <span class="k">return</span> <span class="n">df</span>

<span class="k">def</span> <span class="nf">encode_boolean_to_float</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">column_name</span><span class="p">):</span>
    <span class="n">df</span><span class="p">[</span><span class="n">column_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">column_name</span><span class="p">].</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span>

<span class="k">def</span> <span class="nf">extract_num_of_items_for_column</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">column_name</span><span class="p">):</span>
    <span class="n">df</span><span class="p">[</span><span class="n">column_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">column_name</span><span class="p">].</span><span class="nb">apply</span><span class="p">(</span><span class="n">extract_num_of_items</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span>

<span class="k">def</span> <span class="nf">extract_num_of_items</span><span class="p">(</span><span class="nb">input</span><span class="p">):</span>
    <span class="nb">input</span> <span class="o">=</span> <span class="nb">input</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">","</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="transformation-categorical-column">Transformation: Categorical Column</h2>
<p>Some of the columns contain categorical data, instead of one-hot encoding, I wrote a function to label them</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">encode_category_dic</span><span class="p">(</span><span class="n">dataframe</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">h</span><span class="p">(</span><span class="n">dica</span><span class="p">,</span> <span class="n">columnName</span><span class="p">):</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">dataframe</span><span class="p">[</span><span class="n">columnName</span><span class="p">].</span><span class="n">astype</span><span class="p">(</span>
            <span class="s">'category'</span><span class="p">).</span><span class="n">cat</span><span class="p">.</span><span class="n">categories</span><span class="p">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">encode_dic</span> <span class="o">=</span> <span class="p">{</span><span class="n">columnName</span><span class="p">:</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
            <span class="n">labels</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)))}}</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">dica</span><span class="p">,</span> <span class="o">**</span><span class="n">encode_dic</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">h</span>

<span class="k">def</span> <span class="nf">foldleft</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">acc</span><span class="p">,</span> <span class="n">xs</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">functools</span><span class="p">.</span><span class="nb">reduce</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">xs</span><span class="p">,</span> <span class="n">acc</span><span class="p">)</span>

<span class="c1"># usage
</span><span class="n">category_columns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s">"neighbourhood_group_cleansed"</span><span class="p">,</span>
    <span class="s">"property_type"</span><span class="p">,</span>
    <span class="s">"room_type"</span><span class="p">,</span>
    <span class="s">"bed_type"</span><span class="p">,</span>
    <span class="s">"cancellation_policy"</span>
<span class="p">]</span>

<span class="n">category_encoder</span> <span class="o">=</span> <span class="n">trans</span><span class="p">.</span><span class="n">encode_category_dic</span><span class="p">(</span><span class="n">airbnb</span><span class="p">)</span>
<span class="n">category_dic</span> <span class="o">=</span> <span class="n">trans</span><span class="p">.</span><span class="n">foldleft</span><span class="p">(</span><span class="n">category_encoder</span><span class="p">,</span> <span class="p">{},</span> <span class="n">category_columns</span><span class="p">)</span>
<span class="n">airbnb</span> <span class="o">=</span> <span class="n">airbnb</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="n">category_dic</span><span class="p">)</span>
</code></pre></div></div>

<h1 id="training-the-model">Training the model</h1>
<p>Models like SVCRegressor, LinearRegression and DecisionTree produced very bad results. R<sup>2</sup> score ranged from 0.09-0.12</p>

<p>In the end, <strong>RandomForestRegressor</strong> produced the best model, R<sup>2</sup> score ~0.8</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestRegressor</span>

<span class="n">y</span> <span class="o">=</span> <span class="n">airbnb</span><span class="p">[</span><span class="s">"price"</span><span class="p">]</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">airbnb</span><span class="p">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s">'price'</span><span class="p">])</span>
<span class="n">x_train</span><span class="p">,</span> <span class="n">x_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
<span class="n">rnd_regr</span> <span class="o">=</span> <span class="n">RandomForestRegressor</span><span class="p">(</span>
    <span class="n">min_samples_leaf</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
    <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="n">rnd_regr</span><span class="p">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
</code></pre></div></div>

<h1 id="encode-model-and-upload-to-s3">Encode model and upload to S3</h1>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">s3fs</span>

<span class="k">with</span> <span class="n">s3</span><span class="p">.</span><span class="nb">open</span><span class="p">(</span><span class="s">'airbnb-barcelona/models/rnd_reg.price'</span><span class="p">,</span> <span class="s">'wb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">joblib</span><span class="p">.</span><span class="n">dump</span><span class="p">(</span><span class="n">rnd_regr</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
</code></pre></div></div>

      <div class="page-footer">
        <div class="page-share">
          <a href="https://twitter.com/intent/tweet?text=Airbnb Barcelona Price Prediction&url=/airbnb-barcelona/" title="Share on Twitter" rel="nofollow" target="_blank">Twitter</a>
          <a href="https://facebook.com/sharer.php?u=/airbnb-barcelona/" title="Share on Facebook" rel="nofollow" target="_blank">Facebook</a>
          <a href="https://plus.google.com/share?url=/airbnb-barcelona/" title="Share on Google+" rel="nofollow" target="_blank">Google+</a>
        </div>
        <div class="page-tag">
          
            <a href="/tags#machine-learning" class="tag">&#35; machine-learning</a>
          
        </div>
      </div>
      <section class="comment-area">
  <div class="comment-wrapper">
    
  </div>
</section> <!-- End Comment Area -->

    </div> <!-- End Wrap Content -->
  </div> <!-- End Page Content -->
</article> <!-- End Article Page -->

</div>

  </div>
  
  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', '', 'auto');
  ga('send', 'pageview');
</script> <!-- End Analytics -->

</body>
</html>
